<div class="modal fade" id="modal-add-script" role="dialog">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">

			<div align="center">
				<div class="loading-overlay-admin-panel ng-hide" ng-show="loadingData">
					<span class="glyphicon glyphicon-refresh icon-spin"></span>
				</div>
			</div>


			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Neues Indikatoren-Berechnungs-Skript registrieren</h4>
			</div>
			<div class="modal-body">

				<!-- 
					{
					"scriptCodeBase64": "scriptCodeBase64",
					"requiredIndicatorIds": [
						"requiredIndicatorIds",
						"requiredIndicatorIds"
					],
					"variableProcessParameters": [
						{
						"minParameterValueForNumericInputs": 6.027456183070403,
						"maxParameterValueForNumericInputs": 0.8008281904610115,
						"defaultValue": "defaultValue",
						"dataType": "string",
						"name": "name",
						"description": "description"
						},
						{
						"minParameterValueForNumericInputs": 6.027456183070403,
						"maxParameterValueForNumericInputs": 0.8008281904610115,
						"defaultValue": "defaultValue",
						"dataType": "string",
						"name": "name",
						"description": "description"
						}
					],
					"associatedIndicatorId": "associatedIndicatorId",
					"name": "name",
					"description": "description",
					"requiredGeoresourceIds": [
						"requiredGeoresourceIds",
						"requiredGeoresourceIds"
					]
					}
			 -->

				<!-- MultiStep Form -->
				<div class="row">
					<div class="col-md-12">
						<form class="multiStepForm form-group" id="scriptAddForm" role="form" data-toggle="validator"
							data-disable="true" style="margin-bottom: 0px;">
							<!-- div required for click logic -->
							<div> 
								<!-- progressbar -->
								<ul id="progressbar">
									<li style="width: 25%;" class="active">Einleitende Hinweise</li>
									<li style="width: 25%;">Metadaten des Indikators-Skripts</li>
									<li style="width: 25%;">Zielzeitpunkte und Ausführungszeit</li>
									<li style="width: 25%;">Skriptinhalt und Parametrisierung</li>
								</ul>
							</div>							
							<!-- fieldsets -->

							<fieldset>
								<div class="row">
									<div class="col-md-12">
										<h2 class="fs-title">Einleitende Hinweise</h2>
										<br />
										<div class="text-left">
											<p>KomMonitor erlaubt die automatisierte Fortf&uuml;hrung/Berechnung von Indikatoren aus Georessourcen oder anderen
												(Sub-)Indikatoren. Dazu sind zwei Schritte notwendig:
											</p>
											<ol class="list-unstyled scriptAddFormList">
												<li>
													<b><u>Erster Schritt:</u></b>
													Auswahl / Anlegen des zu berechnenden <b><i>Ziel-Indikators</i></b> mittels Indikatoren-Verwaltung.
													Dabei m&uuml;ssen folgende Punkte ber&uuml;cksichtigt werden:
												</li>
												<br />
												<li>
													<ul class="list-unstyled scriptAddFormList">
														<li class="scriptAddFormChecklistItem">
															<div class="scriptAddFormChecklistItemWrapper">
																<p><i class="glyphicon glyphicon-check scriptAddFormListItemIcon"></i></p>
															</div>
															<div class="scriptAddFormListText">
																Der Fortf&uuml;hrungstyp des Ziel-Indikators ist auf <b><i>&quot;automatische Berechnung durch KomMonitor&quot;</i></b> eingestellt.<br />
															</div>
														</li>
														<li class="scriptAddFormChecklistItem">
															<div class="scriptAddFormChecklistItemWrapper">
																<p><i class="glyphicon glyphicon-check scriptAddFormListItemIcon"></i></p>
																
															</div>
															<div class="scriptAddFormListText">
																Der Aktualisierungszyklus des Ziel-Indikators ist <b>nicht</b> auf &quot;beliebig&quot; eingestellt.<br />
															</div>
														</li>
														<li class="scriptAddFormChecklistItem">
															<div class="scriptAddFormChecklistItemWrapper">
																<p><i class="glyphicon glyphicon-check scriptAddFormListItemIcon"></i></p>
															</div>
															<div class="scriptAddFormListText">
																Die Skriptberechnung erfolgt nur f&uuml; fehlende Zeitschnitte. Um eine Neuberechnung anzutriggern, kann &uuml;ber das Indikatoren-L&ouml;sch-Menü 
																ein ganzer Zeitschnitt des Ziel-Indikators entfernt werden. <br />
															</div>
														</li>
														<li class="scriptAddFormChecklistItem">
															<div class="scriptAddFormChecklistItemWrapper">
																<p><i class="glyphicon glyphicon-check scriptAddFormListItemIcon"></i></p>
															</div>
															<div class="scriptAddFormListText">
																Eine nachtr&auml;gliche Bearbeitung der Skript-Konfiguration zur Berechnung des Ziel-Indikators ist derzeit nicht m&ouml;glich. 
																Stattdessen muss ein vorhandenes Skript entfernt und neu angelegt werden.<br />
															</div>
														</li>
													</ul>
												</li>
												<br />
												<li>
													<b><u>Zweiter Schritt:</u></b>
													Anlegen des Berechnungs-Skripts mittels Skriptverwaltung unter Auswahl des
													zuvor definierten Ziel-Indikators.
												</li>
											</ol>
											<br />
											<p>Das KomMonitor Gesamtsystem umfasst einen sogegannten <b>Processing Scheduler</b>, der anhand der
												Skript- und Indikatoren-Metadaten automatisch die Berechnung der Ziel-Indikatoren-Zeitschnitte antriggert.
												Die Berechnung selbst erfolgt &uuml;ber die <b>Processing Engine</b> Komponente.
											</p>
										</div>
									</div>
								</div>
								

								<input type="button" name="next" class="next next_addScript action-button"
									value="N&auml;chster Schritt" />
							</fieldset>

							<fieldset>
								<h2 class="fs-title">Metadaten des Indikators-Skripts</h2>
								<h3 class="fs-subtitle">Angaben &uuml;ber Metadaten des Indikatoren-Berechnungs-Skripts
								</h3>
								<p><b><i>* = Pflichtfeld</i></b></p>

								<div class="row vertical-align">
									<div class="col-md-4 col-sm-6 col-xs-12">
										<div class="form-group">
											<label>Skriptname*</label>
											<input type="text" class="form-control" ng-model="datasetName"
												placeholder="Name" required></input>
											<div class="help-block with-errors"></div>
											<div class="help-block">
												<p>Name des anzulegenden Skripts.</p>

											</div>
										</div>
									</div>
									<div class="col-md-8 col-sm-6 col-xs-12">
										<div class="form-group">
											<label>Skript-Beschreibung*</label>
											<textarea rows="3" type="text" class="form-control" ng-model="description"
												placeholder="Beschreibung" required></textarea>

											<div class="help-block">
												<p>Hinweise &uuml;ber die Berechnung des Ziel-Indikators mittels des
													Skripts</p>
											</div>
											<div class="help-block with-errors"></div>
										</div>
									</div>

								</div>

								</br><hr></br></br>

								<div class="row vertical-align">
									<div class="col-md-6 col-sm-6 col-xs-12">
										<div class="form-group">
											<label>Ziel-Indikator, der mittels des anzulegenden Skripts berechnet werden
												soll*</label>
											<div class="input-group">
												<span class="input-group-addon"><i class="fas fa-filter"></i></span>
												<input type="text" class="form-control input-sm"
													placeholder="Stichwortfilter" ng-model="indicatorNameFilter" ng-model-options="{debounce: 500, blur: 0}"
													required>
											</div>
											<br />
											<select ng-model="$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator" size="5"
												ng-options="indicatorMetadata as indicatorMetadata.indicatorName + ' [' + indicatorMetadata.unit + ']' for indicatorMetadata in $ctrl.kommonitorDataExchangeServiceInstance.availableIndicators | filter: {creationType: 'COMPUTATION'} | filter:indicatorNameFilter"
												class="form-control" ng-change="onTargetIndicatorChanged()">
												<option disabled selected value> -- Ziel-Indikator w&auml;hlen --
												</option>
											</select>
											<div class="help-block">
												<p>Nur solche Indikatoren mit Fortf&uuml;hrungstyp "Berechnung durch
													KomMonitor" werden hier dargestellt.</p>
											</div>
											<div class="help-block with-errors"></div>
										</div>
									</div>
									<div class="col-md-6 col-sm-6 col-xs-12">
										<div class="row vertical-align">
											<div class="col-md-6 col-sm-6 col-xs-12">
												<div class="form-group">
													<label>ID des selektierten Ziel-Indikators</label>
													<input type="text" class="form-control input-sm" disabled
														placeholder="IndikatorenId" ng-model="$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator.indicatorId">
													<div class="help-block with-errors"></div>
												</div>
											</div>

											<div class="col-md-6 col-sm-6 col-xs-12">
												<div class="form-group">
													<label>Name des selektierten Ziel-Indikators</label>
													<input type="text" class="form-control input-sm" disabled
														placeholder="IndikatorenName" ng-model="$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator.indicatorName">
													<div class="help-block with-errors"></div>
												</div>
											</div>


										</div>

										<div class="row vertical-align">
											<div class="col-md-6 col-sm-6 col-xs-12">
												<div class="form-group">
													<label>Beschreibung des selektierten Ziel-Indikators</label>
													<textarea rows="4" class="form-control input-sm" disabled placeholder="IndikatorenBeschreibung"
														ng-model="$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator.metadata.description"></textarea>
													<div class="help-block with-errors"></div>
												</div>
											</div>
											<div class="col-md-6 col-sm-6 col-xs-12">
												<div class="form-group">
													<label>Einheit des selektierten Ziel-Indikators</label>
													<input type="text" class="form-control input-sm" disabled placeholder="IndikatorenEinheit"
														ng-model="$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator.unit">
													<div class="help-block with-errors"></div>
												</div>
											</div>


										</div>
										
									</div>
								</div>

								</br><hr></br></br>

								<div class="row vertical-align">
									<div class="col-md-6 col-sm-6 col-xs-12">
										<div class="form-group">
											<label>Raumeinheiten</label>
											<ui-select width="max-content" multiple ng-model="$ctrl.kommonitorScriptHelperServiceInstance.processParameters.target_spatial_units">
												<ui-select-match placeholder="Raumeinheiten auswählen">
													{{$item.spatialUnitName}}
												</ui-select-match>
												<ui-select-choices repeat="spatialUnit.spatialUnitId as spatialUnit in applicableSpatialUnits | filter: $select.search">
														{{spatialUnit.spatialUnitName}}
												</ui-select-choices>
											</ui-select>
											<div class="help-block with-errors"></div>
											<div class="help-block">
												<p>Raumeinheiten, für die die Berechnung stattfinden soll</p>
											</div>
										</div>
									</div>
								</div>

								<input type="button" name="previous"
									class="previous previous_addScript action-button-previous"
									value="Voriger Schritt" />

								<input type="button" name="next" class="next next_addScript action-button"
									value="N&auml;chster Schritt" />

							</fieldset>

							<fieldset>
								<h2 class="fs-title">Zielzeitpunkte und Ausführungszeit</h2>
								<h3 class="fs-subtitle">
								</h3>
								<p><b><i>* = Pflichtfeld</i></b></p>

								<div class="row vertical-align">
									<div class="form-group">
										<label>Zeitpunkte, die berechnet werden sollen: </label>
										<br />
										<select ng-model="$ctrl.kommonitorScriptHelperServiceInstance.processParameters.targetTime.mode"
											ng-options="targetTimeOption as targetTimeOption.displayName for targetTimeOption in $ctrl.kommonitorScriptHelperServiceInstance.targetTimeOptions"
											ng-change="resetApplicableDates()">
											<option disabled selected value> -- Zeitpunkte w&auml;hlen --
											</option>
										</select>
										<div class="help-block with-errors"></div>
									</div>
								</div>

								<div class="row vertical-align">
									<div class="col-md-6 col-sm-6 col-xs-12">
										<div class="form-group">
											<input id="notDates" type="checkbox"><label for="notDates">Nicht berechnen für: </label>
											<ui-select width="max-content" multiple ng-model="$ctrl.kommonitorScriptHelperServiceInstance.processParameters.targetTime.excludeDates">
												<ui-select-match placeholder="Daten auswählen">
													{{$item}}
												</ui-select-match>
												<ui-select-choices repeat="date in applicableDates | filter: $select.search">
														{{date}}
												</ui-select-choices>
											</ui-select>
											<div class="help-block with-errors"></div>
											<div class="help-block">
												<p>Zeitpunkte, die von der Berechnung ausgeschlossen werden sollen</p>
											</div>
										</div>
									</div>
									<div class="col-md-6 col-sm-6 col-xs-12">
										<div class="form-group">
											<input id="additionalDates" type="checkbox"><label for="additionalDates">Zusätzlich berechnen für: </label>
											<ui-select width="max-content" multiple ng-model="$ctrl.kommonitorScriptHelperServiceInstance.processParameters.targetTime.includeDates">
												<ui-select-match placeholder="Daten auswählen">
													{{$item}}
												</ui-select-match>
												<ui-select-choices repeat="date in applicableDates | filter: $select.search">
														{{date}}
												</ui-select-choices>
											</ui-select>
											<div class="help-block with-errors"></div>
											<div class="help-block">
												<p>Zeitpunkte, die berechnet werden sollen, auch wenn sie bereits berechnet wurden</p>
											</div>
										</div>
									</div>
								</div>

							</br><hr></br></br>

								<div class="row vertical-align">
									<div class="form-group">
										<label>Ausführungsintervall </label>
											<input type="text" class="form-control" ng-model="$ctrl.kommonitorScriptHelperServiceInstance.processParameters.execution_interval.cron"
												placeholder="z.B. 0 0 1 * *" required></input>
										<div class="help-block with-errors"></div>
										<div class="help-block">
											<p>Bitte ein Ausführungsintervall in einem Cron Ausdruck angeben
												(-><a href="https://crontab.guru/" target="_blank">https://crontab.guru/</a>)
											</p>
										</div>
									</div>
								</div>

								<input type="button" name="previous"
									class="previous previous_addScript action-button-previous"
									value="Voriger Schritt" />

								<input type="button" name="next" class="next next_addScript action-button"
									value="N&auml;chster Schritt" />

							</fieldset>

							<fieldset>
								<h2 class="fs-title">Skriptinhalt und Parametrisierung</h2>
								<h3 class="fs-subtitle">Angaben &uuml;ber den Skript-Code und notwendige
									Skript-Parameter</h3>

								<p>Die Berechnung von Indikatoren erfolgt in KomMonitor mittels eines
									<b>Skript-basierten
										Ansatzes</b>, f&uuml;r den Angaben &uuml;ber notwendige
									<i>(Basis-)Indikatoren</i> und/oder
									<i>Georessourcen</i> sowie <i>variable Skript-Parameter</i> und den <i>Skript
										Code</i> selbst erforderlich sind.
								</p>

								<p>Der Skript Code muss dabei einem festgelegten Template folgen. Das Template steht
									unter folgendem Link bereit: <a
										href="./kommonitor-script-resources/kommonitor-script-template.js"
										rel='noopener noreferrer' target='_blank'>KomMonitor Skript Template</a>.
									<br />
									Hinweise zur Skript-Entwicklung befinden sich im github Repository der <a
										href="https://github.com/KomMonitor/processing-engine/tree/master/resources"
										rel='noopener noreferrer' target='_blank'>KomMonitor Processing Engine</a>
								</p>

								<!-- <p>Neben einer generischen Definition bietet diese Oberfl&auml;che f&uuml;r g&auml;ngige Berechnungsf&auml;lle vereinfachte Eingabemasken.</p> -->

								<p><b><i>* = Pflichtfeld</i></b></p>



								<div class="row vertical-align">
									<div class="col-md-6 col-sm-6 col-xs-12">
										<div class="form-group">
											<label>Auswahl des Skript-Typen*</label>
											<div class="input-group">
												<span class="input-group-addon"><i class="fas fa-filter"></i></span>
												<input type="text" class="form-control input-sm"
													placeholder="Stichwortfilter" ng-model="scriptNameFilter" ng-model-options="{debounce: 500, blur: 0}"> 
											</div>
											<br />
											<select ng-model="selectedScriptType" size="10"
												ng-options="scriptType as scriptType.displayName for scriptType in $ctrl.kommonitorScriptHelperServiceInstance.availableScriptTypeOptions | orderBy: 'displayName' | filter:scriptNameFilter"
												class="form-control">
												<option disabled selected value> -- Skript-Typ w&auml;hlen --
												</option>
											</select>
											<div class="help-block">
												<p>Die Option <b>Generische Definition</b> bedarf der manuellen
													Definition aller Skript-Daten. Die &uuml;brigen Auswahloptionen
													bieten vereinfachte Eingabemasken, die im Hintergrund die
													notwendigen Skript-Daten sowie den vordefinierten Skript-Code
													automatisch setzen.</p>
											</div>
											<div class="help-block with-errors"></div>
										</div>
									</div>
								</div>

								<!-- ACTUAL SCRIPT FIELDS DEPENDING ON SELECTION OF SCRIPT TYPE; AS ANGULAR MODULES -->
								<div ng-if="selectedScriptType.apiName === 'test'">
									<script-test></script-test>
								</div>
								
								<div ng-if="selectedScriptType.apiName === 'generic'">
									<script-generic></script-generic>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_sum'">
									<script-sum></script-sum>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_subtract'">
									<script-subtract></script-subtract>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_promille'">
									<script-promille></script-promille>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_percentage'">
									<script-percentage></script-percentage>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_share'">
									<script-share></script-share>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_division'">
									<script-division></script-division>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_change_absolute'">
									<script-change-absolute></script-change-absolute>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_change_absolute_refDate'">
									<script-change-absolute-ref-date></script-change-absolute-ref-date>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_change_relative_refDate'">
									<script-change-relative-ref-date></script-change-relative-ref-date>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_change_relative'">
									<script-change-relative></script-change-relative>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_trend'">
									<script-trend></script-trend>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_continuity'">
									<script-continuity></script-continuity>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_headlineIndicator'">
									<script-headline-indicator></script-headline-indicator>
								</div>

								<div ng-if="selectedScriptType.apiName === 'indicator_multiplication'">
									<script-multiplication></script-multiplication>
								</div>

								<div ng-if="selectedScriptType.apiName === 'georesource_pointsInPolygon'">
									<script-points-in-polygon></script-points-in-polygon>
								</div>

								<div ng-if="selectedScriptType.apiName === 'georesource_statistics'">
									<script-georesource-statistics></script-georesource-statistics>
								</div>

								<div ng-if="selectedScriptType.apiName === 'georesource_subsetShare'">
									<script-georesource-subset-share></script-georesource-subset-share>
								</div>

								<div ng-if="selectedScriptType.apiName === 'lineSegmentInPolygon'">
									<script-line-segment-in-polygon></script-line-segment-in-polygon>
								</div>

								<input type="button" name="previous"
									class="previous previous_addScript action-button-previous"
									value="Voriger Schritt" />
							</fieldset>
						</form>
					</div>
				</div>

			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default pull-left" data-dismiss="modal">Schlie&szlig;en</button>

				<button type="button" class="btn btn-success"
					ng-disabled="!datasetName || !description || !$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator || !$ctrl.kommonitorScriptHelperServiceInstance.scriptCode_readableString || (($ctrl.kommonitorScriptHelperServiceInstance.requiredIndicators_tmp.length == 0) && ($ctrl.kommonitorScriptHelperServiceInstance.requiredGeoresources_tmp.length == 0))" ng-click="addScript()">Skript
					registrieren</button>
				<button type="button" class="btn btn-danger" ng-click="resetScriptAddForm()">Zur&uuml;cksetzen</button>
			</div>

			<div id="scriptAddSuccessAlert" style="position: absolute; bottom: 0px; width: 100%;" hidden
				class="alert alert-success alert-dismissable">
				<button type="button" class="close" ng-click="hideSuccessAlert()" aria-hidden="true">&times;</button>
				<h4><i class="icon fa fa-check"></i>Berechnungsskript registriert</h4>
				<p>Eine neues Indikatoren-Berechnungsskript mit Namen {{datasetName}} f&uuml;r Ziel-Indikator
					{{$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator.indicatorName}} wurde in KomMonitor registriert und in die
					&Uuml;bersichtstabelle eingetragen.
				</p>
			</div>

			<div id="scriptAddErrorAlert" style="position: absolute; bottom: 0px; width: 100%;" hidden
				class="alert alert-danger alert-dismissable">
				<button type="button" class="close" ng-click="hideErrorAlert()" aria-hidden="true">&times;</button>
				<h4><i class="icon fa fa-ban"></i>Skript-Registrierung gescheitert</h4>
				Bei der Registrierung des Skripts ist ein Fehler aufgetreten. Fehlermeldung:
				<br />
				<pre style="overflow:auto; max-height:500px;" ng-bind-html="errorMessagePart"></pre>
			</div>

			<div id="indicatorMetadataEditSuccessAlert" style="position: absolute; bottom: 0px; width: 100%;" hidden
				class="alert alert-success alert-dismissable">
				<button type="button" class="close" ng-click="hideSuccessAlert_indicatorMetadata()" aria-hidden="true">&times;</button>
				<h4><i class="icon fa fa-check"></i>Aktualisierung der Ziel-Indikator Methodik erfolgreich</h4>
				<p>Der Metadaten-Eintrag f&uuml;r die Berechnungs-Methodik des Ziel-Indikators
					{{$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator.indicatorName}} wurde in KomMonitor erfolgreich &uuml;berschrieben.
				</p>
				<p>Alter Eintrag:</p>
				<pre mathjax-bind="$ctrl.kommonitorScriptHelperServiceInstance.targetIndicatorOldProcessDescription"></pre>
				<p>Neuer Eintrag:</p>
				<pre mathjax-bind="$ctrl.kommonitorScriptHelperServiceInstance.scriptFormulaHTML_successToastDisplay"></pre>				
			</div>

			<div id="indicatorMetadataEditErrorAlert" style="position: absolute; bottom: 0px; width: 100%;" hidden
				class="alert alert-danger alert-dismissable">
				<button type="button" class="close" ng-click="hideErrorAlert_indicatorMetadata()" aria-hidden="true">&times;</button>
				<h4><i class="icon fa fa-ban"></i>Aktualisierung der Ziel-Indikator Methodik gescheitert</h4>
				Bei der Editierung des Metadaten-Eintrags f&uuml;r die Berechnungs-Methodik des Ziel-Indikators
				{{$ctrl.kommonitorScriptHelperServiceInstance.targetIndicator.indicatorName}} ist ein Fehler aufgetreten. Fehlermeldung:
				<br />
				<pre style="overflow:auto; max-height:500px;" ng-bind-html="errorMessagePart_indicatorMetadata"></pre>
			</div>

		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->