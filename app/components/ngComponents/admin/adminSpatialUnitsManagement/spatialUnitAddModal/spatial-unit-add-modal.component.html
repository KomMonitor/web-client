<div class="modal-header">
  <button type="button" class="close" aria-label="Close" (click)="cancel()">
    <span aria-hidden="true">&times;</span>
  </button>
  <h4 class="modal-title">Neue Raumebene registrieren</h4>
</div>

<div class="modal-body">
  <div align="center">
    <div class="loading-overlay-admin-panel" *ngIf="loadingData">
      <span class="glyphicon glyphicon-refresh icon-spin"></span>
    </div>
  </div>

  <!-- MultiStep Form -->
  <form class="multiStepForm form-group" #spatialUnitAddForm="ngForm" (ngSubmit)="addSpatialUnit()" style="margin-bottom: 0px;">
    <!-- progressbar -->
    <ul id="progressbar" *ngIf="!kommonitorDataExchangeService.enableKeycloakSecurity">
      <li [class.active]="currentStep >= 1" [class.clickable]="true" (click)="goToStep(1)" style="width: 33.33%; cursor: pointer;">Metadaten der Raumebene</li>
      <li [class.active]="currentStep >= 2" [class.clickable]="true" (click)="goToStep(2)" style="width: 33.33%; cursor: pointer;">Allgemeine Metadaten</li>
      <li [class.active]="currentStep >= 3" [class.clickable]="true" (click)="goToStep(3)" style="width: 33.33%; cursor: pointer;">Räumlicher Datensatz</li>
    </ul>
    <ul id="progressbar" *ngIf="kommonitorDataExchangeService.enableKeycloakSecurity">
      <li [class.active]="currentStep >= 1" [class.clickable]="true" (click)="goToStep(1)" style="width: 25%; cursor: pointer;">Metadaten der Raumebene</li>
      <li [class.active]="currentStep >= 2" [class.clickable]="true" (click)="goToStep(2)" style="width: 25%; cursor: pointer;">Allgemeine Metadaten</li>
      <li [class.active]="currentStep >= 3" [class.clickable]="true" (click)="goToStep(3)" style="width: 25%; cursor: pointer;">Zugriffsschutz und Eigentümerschaft</li>
      <li [class.active]="currentStep >= 4" [class.clickable]="true" (click)="goToStep(4)" style="width: 25%; cursor: pointer;">Räumlicher Datensatz</li>
    </ul>

    <!-- Step 1: Metadaten der Raumebene -->
    <fieldset *ngIf="currentStep === 1">
      <h2 class="fs-title">Metadaten der Raumebene</h2>
      <h3 class="fs-subtitle">Angaben über die neue Raumebene</h3>
      <p><b><i>* = Pflichtfeld</i></b></p>

      <div class="row vertical-align">
        <div class="col-md-4 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Name der Raumebene*</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="spatialUnitLevel"
              name="spatialUnitLevel"
              (ngModelChange)="checkSpatialUnitName()"
              placeholder="eindeutiger Name" 
              required
            >
            <div class="help-block with-errors"></div>
            <div *ngIf="spatialUnitLevelInvalid" style="color: red;">
              <p>Eingabe ungültig. Es existiert bereits eine Raumebene mit gleichem Namen.</p>
            </div>
          </div>
        </div>
        <div class="col-md-4 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Hierarchie: nächst niedrigere Ebene</label>
            <select 
              [(ngModel)]="nextLowerHierarchySpatialUnit"
              name="nextLowerHierarchy"
              (ngModelChange)="checkSpatialUnitHierarchy()"
              class="form-control"
            >
              <option [ngValue]="null"> -- Raumebene wählen -- </option>
              <option [ngValue]="null"> -- keine (neue unterste Ebene) -- </option>
              <option *ngFor="let value of availableSpatialUnits" [ngValue]="value">
                {{value.spatialUnitLevel}}
              </option>
            </select>
            <div class="help-block">
              <p>Eintrag kann im Nachhinein mittels Metadaten-Editier-Funktion gesetzt werden</p>
            </div>
            <div class="help-block with-errors"></div>
            <div *ngIf="hierarchyInvalid" style="color: red;">
              <p>Eingabe ungültig. Definierte Hierarchie ist nicht erlaubt.</p>
            </div>
          </div>
        </div>
        <div class="col-md-4 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Hierarchie: nächst höhere Ebene</label>
            <select 
              [(ngModel)]="nextUpperHierarchySpatialUnit"
              name="nextUpperHierarchy"
              (ngModelChange)="checkSpatialUnitHierarchy()"
              class="form-control"
            >
              <option [ngValue]="null"> -- Raumebene wählen -- </option>
              <option [ngValue]="null"> -- keine (neue oberste Ebene) -- </option>
              <option *ngFor="let value of availableSpatialUnits" [ngValue]="value">
                {{value.spatialUnitLevel}}
              </option>
            </select>
            <div class="help-block">
              <p>Eintrag kann im Nachhinein mittels Metadaten-Editier-Funktion gesetzt werden</p>
            </div>
            <div class="help-block with-errors"></div>
            <div *ngIf="hierarchyInvalid" style="color: red;">
              <p>Eingabe ungültig. Definierte Hierarchie ist nicht erlaubt.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row vertical-align">
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>als Umringslayer markieren?</label>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="isOutlineLayer" name="isOutlineLayer">
              <span class="switchslider round"></span>
            </label>
            <div class="help-block">
              <p>wenn markiert, dann wird in der Kartenapplikation in der Layersteuerung ein entsprechender Eintrag zur Darstellung der Raumebenenumringe angeboten</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12" *ngIf="isOutlineLayer">
          <div class="form-group" align="center">
            <label>Linienfarbe (Umringslayer)</label>
            <div id="outlineColorPicker" class="input-group" style="width: 50px;">
              <input 
                type="color" 
                class="form-control input-sm"
                [(ngModel)]="loiColor"
                name="loiColor"
                style="width: 100%; height: 34px;"
              />
            </div>
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12" *ngIf="isOutlineLayer">
          <div class="form-group" align="center">
            <label>Linienbreite (Umringslayer)</label>
            <br/>
            <input 
              style="width: auto;" 
              type="number" 
              [(ngModel)]="outlineWidth"
              name="outlineWidth"
              min="1" 
              max="5" 
              step="1"
            >
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12" *ngIf="isOutlineLayer">
          <div class="form-group" align="center">
            <label>Linienmuster (Umringslayer)</label>
            <div class="dropdown">
              <button type="button" width="200px" class="btn btn-info dropdown-toggle"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <div id="outlineDashArrayDropdownButton_addSpatialUnit">
                </div> <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-center">
                <li *ngFor="let outlineDashArrayObject of availableLoiDashArrayObjects; let i = index"
                  (click)="onChangeOutlineDashArray(outlineDashArrayObject)">
                  <a href="">
                    <div id="outlineDashArrayDropdownItem-{{i}}">
                    </div>
                  </a>
                </li>
              </ul>
              <div class="help-block with-errors"></div>
            </div>
          </div>
        </div>
      </div>

      <input type="button" name="next" class="next next_addSpatialUnit action-button" value="Nächster Schritt" (click)="nextStep()"/>
    </fieldset>

    <!-- Step 2: Allgemeine Metadaten -->
    <fieldset *ngIf="currentStep === 2">
      <h2 class="fs-title">Allgemeine Metadaten</h2>
      <h3 class="fs-subtitle">Angaben über allgemeine Metadaten in KomMonitor</h3>
      <p><b><i>* = Pflichtfeld</i></b></p>

      <div class="row vertical-align">
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Beschreibung*</label>
            <textarea 
              rows="3" 
              class="form-control" 
              [(ngModel)]="metadata.description"
              name="description"
              placeholder="Datensatz Beschreibung"
              required
            ></textarea>
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Datenbasis</label>
            <textarea 
              rows="3" 
              class="form-control" 
              [(ngModel)]="metadata.databasis"
              name="databasis"
              placeholder="optionale Beschreibung etwaiger grundlegender Daten, die zur Erzeugung des Datensatzes beitragen"
            ></textarea>
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Datenquelle*</label>
            <textarea 
              rows="3" 
              class="form-control" 
              [(ngModel)]="metadata.datasource"
              name="datasource"
              placeholder="Beschreibung der Datenquelle" 
              required
            ></textarea>
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Datenhalter und Kontakt*</label>
            <textarea 
              rows="3" 
              class="form-control" 
              [(ngModel)]="metadata.contact"
              name="contact"
              placeholder="Beschreibung des Datenhalters und etwaiger Kontaktinformationen" 
              required
            ></textarea>
            <div class="help-block with-errors"></div>
          </div>
        </div>
      </div>

      <div class="row vertical-align">
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Aktualisierungszyklus*</label>
            <select 
              [(ngModel)]="metadata.updateInterval"
              name="updateInterval"
              class="form-control" 
              required
            >
              <option [ngValue]="null"> -- Aktualisierungszyklus wählen -- </option>
              <option *ngFor="let value of updateIntervalOptions" [ngValue]="value">
                {{value.displayName}}
              </option>
            </select>
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Datum der letzten Aktualisierung*</label>
            <div class="input-group date">
              <div class="input-group-addon">
                <i class="far fa-calendar-alt"></i>
              </div>
              <input 
                type="text" 
                [(ngModel)]="metadata.lastUpdate"
                name="lastUpdate"
                class="form-control pull-right"
                placeholder="YYYY-MM-DD" 
                required
              >
            </div>
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Literatur</label>
            <textarea 
              rows="3" 
              class="form-control" 
              [(ngModel)]="metadata.literature"
              name="literature"
              placeholder="optionale Angaben zu Literatur"
            ></textarea>
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Bemerkung</label>
            <textarea 
              rows="3" 
              class="form-control" 
              [(ngModel)]="metadata.note"
              name="note"
              placeholder="optionale Bemerkung"
            ></textarea>
            <div class="help-block with-errors"></div>
          </div>
        </div>
      </div>

      <input type="button" name="previous" class="previous previous_addSpatialUnit action-button-previous" value="Voriger Schritt" (click)="previousStep()"/>
      <input type="button" name="next" class="next next_addSpatialUnit action-button" value="Nächster Schritt" (click)="nextStep()"/>
    </fieldset>

    <!-- Step 3: Zugriffsschutz und Eigentümerschaft (Security) -->
    <fieldset *ngIf="currentStep === 3 && kommonitorDataExchangeService.enableKeycloakSecurity">
      <h2 class="fs-title">Zugriffsschutz und Eigentümerschaft</h2>
      <h3 class="fs-subtitle">Vergabe der Zugriffsrechte auf Datensatz-Metadaten und -Features pro Organisationseinheit</h3>
      <div class="row">
        <div class="col-md-3"></div>
        <div class="col-md-6 col-sm-6 col-xs-12">
          <div class="alert alert-info">
            Bitte wählen Sie zunächst die Organisationseinheit aus, unter welcher Sie den Datensatz anlegen möchten
          </div>
          <label for="addSpatialUnitUserRoleSelect">Eigentümer-Organisationseinheit*</label>
          <div class="input-group">
            <span class="input-group-addon"><i class="fas fa-filter"></i></span>
            <input type="text" class="form-control input-sm" placeholder="Stichwortfilter" [(ngModel)]="ownerOrgFilter" name="ownerOrgFilter">
          </div>
          <select *ngIf="kommonitorDataExchangeService.checkAdminPermission()" id="addSpatialUnitUserRoleSelect" [(ngModel)]="ownerOrganization" name="ownerOrganization" class="form-control" (ngModelChange)="onChangeOwner(ownerOrganization)" required>
            <option *ngFor="let org of kommonitorDataExchangeService.accessControl" [value]="org.organizationalUnitId">{{org.name}}</option>
          </select>		
          <select *ngIf="!kommonitorDataExchangeService.checkAdminPermission()" id="addSpatialUnitUserRoleSelect" [(ngModel)]="ownerOrganization" name="ownerOrganization" class="form-control" (ngModelChange)="onChangeOwner(ownerOrganization)" required>
            <option *ngFor="let org of resourcesCreatorRights" [value]="org.organizationalUnitId">{{org.name}}</option>
          </select>		
          <p></p>
        </div>
        <div class="col-md-3"></div>
      </div>	

      <br>
      <hr>
      <br>

      <div id="spatialUnitRoleForm">
        <label>Datensatz-Freigaben</label>
        <div class="row vertical-align">
          <div class="col-md-3">
            <label>Öffentliche Lesefreigabe*</label>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="isPublic" name="isPublic" (ngModelChange)="onChangeIsPublic(isPublic)">
              <span class="switchslider round"></span>
            </label>
            <div class="help-block">
              <p>
                Öffentlich freigegebene Datensätze können ohne Login abgerufen werden.
              </p>
            </div>
          </div>
          <div class="col-md-6 col-sm-6 col-xs-12">
            <div id="spatialUnitAddRoleManagementTable" style="height: 45vh" class="ag-theme-alpine"></div>  
          </div>
          <div class="col-md-3">
            <div class="alert alert-info">
              Als Eigentümer-Organisation des Datensatzes können Sie Lese- und Editier-Rechte an die eigene und weitere Organisationseinheiten vergeben. 
            </div>
            <br/>
            <div class="alert alert-warning">
              Lese- und Editierrechte wurden für die von Ihnen selektierte Eigentümer-Organisationseinheit markiert. 
            </div>
          </div>
        </div>	
      </div>
      
      <input type="button" name="previous" class="previous previous_addSpatialUnit action-button-previous" value="Voriger Schritt" (click)="previousStep()"/>
      <input type="button" name="next" class="next next_addSpatialUnit action-button" value="Nächster Schritt" (click)="nextStep()"/>
    </fieldset>

    <!-- Step 3/4: Räumlicher Datensatz -->
    <fieldset *ngIf="(currentStep === 3 && !kommonitorDataExchangeService.enableKeycloakSecurity) || (currentStep === 4 && kommonitorDataExchangeService.enableKeycloakSecurity)">
      <div style="position: absolute;">
        <button type="button" class="btn btn-info pull-left" (click)="onImportSpatialUnitAddMappingConfig()" title="Importieren der Mapping-Konfigurationen aus einer Datei">
          <i class="fas fa-file-import"></i>&nbsp;&nbsp;Mapping-Import
        </button>
        <input style="display:none;" class="pull-left" type="file" #mappingConfigImportFile (change)="onMappingConfigFileSelected($event)" accept=".json,">
        <button type="button" style="margin-left: 6px;" class="btn btn-info pull-left" (click)="onExportSpatialUnitAddMappingConfig()" title="Exportieren der Mapping-Konfigurationen in eine Datei">
          <i class="fas fa-file-export"></i>&nbsp;&nbsp;Mapping-Export
        </button>
      </div>
      <h2 class="fs-title">Räumlicher Datensatz</h2>
      <h3 class="fs-subtitle">Angaben über den räumlichen Datensatz, aus dem die Raumeinheiten importiert werden</h3>
      <p><b><i>* = Pflichtfeld</i></b></p>

      <div class="row vertical-align">
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Geodaten-Quellformat*</label>
            <select 
              [(ngModel)]="converter"
              name="converter"
              (ngModelChange)="onChangeConverter()"
              class="form-control" 
              required
            >
              <option [ngValue]="null"> -- Quellformat wählen -- </option>
              <option *ngFor="let converter of kommonitorImporterHelperService.availableConverters" [ngValue]="converter">
                {{converter.name}}
              </option>
            </select>
            <div class="help-block with-errors"></div>
          </div>
          <div *ngIf="converter?.schemas">
            <div class="form-group">
              <label>Schema*</label>
              <select 
                [(ngModel)]="schema" 
                name="schema"
                class="form-control" 
                required
              >
                <option [ngValue]="''"> -- Schema wählen -- </option>
                <option *ngFor="let schema of converter.schemas" [ngValue]="schema">
                  {{schema}}
                </option>
              </select>
              <div class="help-block with-errors"></div>
            </div>
          </div>
          <div *ngIf="converter?.mimeTypes">
            <div class="form-group">
              <label>Quellformat*</label>
              <select 
                [(ngModel)]="mimeType" 
                name="mimeType"
                (ngModelChange)="onChangeMimeType(mimeType)"
                class="form-control" 
                required
              >
                <option [ngValue]="''"> -- Format wählen -- </option>
                <option *ngFor="let mimeType of converter.mimeTypes" [ngValue]="mimeType">
                  {{mimeType}}
                </option>
              </select>
              <div class="help-block with-errors"></div>
            </div>
          </div>
          <div *ngFor="let parameter of converter?.parameters">
            <div class="form-group">
              <label>{{parameter.name}}<i *ngIf="parameter.mandatory">*</i></label>
              <input 
                type="text" 
                [id]="'converterParameter_spatialUnitAdd_' + parameter.name" 
                class="form-control"
                [placeholder]="parameter.name" 
                [required]="parameter.mandatory"
              >
              <div class="help-block">
                <p>{{parameter.description}}</p>
              </div>
              <div *ngIf="parameter.name === 'CRS'" class="help-block with-errors" style="color: red;">
                <p>CRS aufmerksam setzen. Falsche Angaben führen zur fehlerhaften Koordinaten der Raumeinheiten</p>
              </div>
              <div class="help-block with-errors"></div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <div *ngIf="!converter">
              <p>bitte zuerst das Quellformat wählen</p>
            </div>
            <div *ngIf="converter">
              <div class="form-group">
                <label>Datenquelltyp*</label>
                <select 
                  [(ngModel)]="datasourceType"
                  name="datasourceType"
                  (ngModelChange)="onChangeDatasourceType(datasourceType)"
                  class="form-control" 
                  required
                >
                  <option [ngValue]="null"> -- Quelltyp wählen -- </option>
                  <option *ngFor="let datasourceType of availableDatasourceTypes" [ngValue]="datasourceType">
                    {{datasourceType.type}}
                  </option>
                </select>
                <div class="help-block"></div>
              </div>

              <div *ngIf="datasourceType?.type === 'FILE'">
                <label>Datei*</label>
                <input type="file" class="form-control" #spatialUnitDataSourceInput required>
              </div>
              <div *ngIf="datasourceType?.type === 'OGCAPI_FEATURES'">
                <label>Räumlicher Filter*</label>
                <select id="datasourceTypeParameter_spatialUnitAdd_bboxType" [(ngModel)]="bboxType" name="bboxType" class="form-control" required>
                  <option value=""> -- Filter wählen -- </option>
                  <option value="ref"> Referenzraumebene </option>
                  <option value="literal"> Manueller Begrenzungsrahmen </option>
                </select>

                <div *ngIf="bboxType === 'ref'">
                  <!-- select available spatialUnits -->
                  <select id="datasourceTypeParameter_spatialUnitAdd_bboxRef"
                    [(ngModel)]="bboxRefSpatialUnit"
                    name="bboxRefSpatialUnit"
                    class="form-control" 
                    required>
                    <option [ngValue]="null"> -- Raumebene wählen -- </option>
                    <option *ngFor="let spatialUnit of availableSpatialUnits" [ngValue]="spatialUnit">
                      {{spatialUnit.spatialUnitLevel}}
                    </option>
                  </select>
                  <div class="help-block">
                    <p>Raumebene aus welchem ein umschließendes Rechteck extrahiert wird</p>
                  </div>
                </div>
                <div *ngIf="bboxType === 'literal'">
                  <label>Begrenzungsrahmen*</label>
                  <input id="datasourceTypeParameter_spatialUnitAdd_bbox_minx" class="form-control" type="number" lang="us" placeholder="-180" required>
                  <div class="help-block">
                    <p>Minimale x-Koordinate</p>
                  </div>
                  <input id="datasourceTypeParameter_spatialUnitAdd_bbox_miny" class="form-control" type="number" lang="us" placeholder="-90" required>
                  <div class="help-block">
                    <p>Minimale y-Koordinate</p>
                  </div>
                  <input id="datasourceTypeParameter_spatialUnitAdd_bbox_maxx" class="form-control" type="number" lang="us" placeholder="180" required>
                  <div class="help-block">
                    <p>Maximale x-Koordinate</p>
                  </div>
                  <input id="datasourceTypeParameter_spatialUnitAdd_bbox_maxy" class="form-control" type="number" lang="us" placeholder="90" required>
                  <div class="help-block">
                    <p>Maximale y-Koordinate</p>
                  </div>
                </div>
              </div>
              <div *ngIf="datasourceType && datasourceType.type !== 'FILE'">
                <div *ngFor="let parameter of datasourceType.parameters">
                  <div class="form-group" *ngIf="parameter.name !== 'bbox'">
                    <label *ngIf="parameter.mandatory">{{parameter.name}}*</label>
                    <label *ngIf="!parameter.mandatory">{{parameter.name}}</label>
                    <textarea 
                      rows="1" 
                      [id]="'datasourceTypeParameter_spatialUnitAdd_' + parameter.name"
                      class="form-control" 
                      [placeholder]="parameter.name" 
                      [required]="parameter.mandatory"
                    ></textarea>
                    <div class="help-block">
                      <p>{{parameter.description}}</p>
                    </div>
                    <div class="help-block with-errors"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="help-block with-errors"></div>
            <div *ngIf="spatialUnitDataSourceInputInvalid" style="color: red;">
              <p>Eingabe ungültig. Grund: {{spatialUnitDataSourceInputInvalidReason}}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>ID Attributname*</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="spatialUnitDataSourceIdProperty"
              name="spatialUnitDataSourceIdProperty"
              required
            >
            <div class="help-block">
              <p>Name des Attributs, welches den eindeutigen Identifier des Raumeinheiten enthält.</p>
            </div>
            <div class="help-block with-errors"></div>
            <div *ngIf="idPropertyNotFound" style="color: red;">
              <p>Eingabe ungültig. Angegebenes Attribut nicht gefunden oder enthält NULL-Werte.</p>
            </div>
          </div>
          <div class="form-group">
            <label>NAME Attributname*</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="spatialUnitDataSourceNameProperty"
              name="spatialUnitDataSourceNameProperty"
              required
            >
            <div class="help-block">
              <p>Name des Attributs, welches den eindeutigen Namen des Raumeinheiten enthält.</p>
            </div>
            <div class="help-block with-errors"></div>
            <div *ngIf="namePropertyNotFound" style="color: red;">
              <p>Eingabe ungültig. Angegebenes Attribut nicht gefunden oder enthält NULL-Werte.</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Lebenszeit-Beginn Attributname</label>
            <input 
              type="text" 
              [(ngModel)]="validityStartDate_perFeature"
              name="validityStartDate_perFeature"
              class="form-control pull-right"
            >
            <div class="help-block">
              <p>Eintrag nur, falls die räumlichen Raumeinheiten über ein Attribut für den Lebenszeitraum (Beginn) verfügen.</p>
            </div>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label>Lebenszeit-Ende Attributname</label>
            <input 
              type="text" 
              [(ngModel)]="validityEndDate_perFeature"
              name="validityEndDate_perFeature"
              class="form-control pull-right"
            >
            <div class="help-block">
              <p>Eintrag nur, falls die räumlichen Raumeinheiten über ein Attribut für den Lebenszeitraum (Ende) verfügen.</p>
            </div>
            <div class="help-block with-errors"></div>
          </div>
        </div>
      </div>

      <div class="row vertical-align">
        <div class="col-md-6 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Gültigkeitszeitraum: gültig seit*</label>
            <div class="input-group date">
              <div class="input-group-addon">
                <i class="far fa-calendar-alt"></i>
              </div>
              <input 
                type="text" 
                [(ngModel)]="periodOfValidity.startDate"
                name="periodStartDate"
                (ngModelChange)="checkPeriodOfValidity()"
                class="form-control pull-right" 
                placeholder="YYYY-MM-DD" 
                required
              >
            </div>
            <div class="help-block">
              <p>Eintrag ist immer erforderlich, selbst wenn die räumlichen Raumeinheiten über ein Lebenszeitraum-Attribut verfügen.</p>
            </div>
            <div class="help-block with-errors"></div>
            <div *ngIf="periodOfValidityInvalid" style="color: red;">
              <p>Eingabe ungültig. Definiertes Zeitintervall ist nicht erlaubt.</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Gültigkeitszeitraum: gültig bis</label>
            <div class="input-group date">
              <div class="input-group-addon">
                <i class="far fa-calendar-alt"></i>
              </div>
              <input 
                type="text" 
                [(ngModel)]="periodOfValidity.endDate"
                name="periodEndDate"
                (ngModelChange)="checkPeriodOfValidity()"
                class="form-control pull-right" 
                placeholder="YYYY-MM-DD"
              >
            </div>
            <div class="help-block">
              <p>Eintrag ist erforderlich, falls die räumlichen Raumeinheiten nicht selbst über ein Lebenszeitraum-Attribut verfügen. Enddatum darf leer sein, um anzuzeigen, dass es sich um aktuell gültige Raumeinheiten handelt.</p>
            </div>
            <div class="help-block with-errors"></div>
            <div *ngIf="periodOfValidityInvalid" style="color: red;">
              <p>Eingabe ungültig. Definiertes Zeitintervall ist nicht erlaubt.</p>
            </div>
          </div>
        </div>
      </div>

      <hr>
      <br/>

      <div class="row vertical-align">
        <div class="col-md-6 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Import weiterer Attribute*</label>
            <br/>	
            <label class="switch">
              <input type="checkbox" [(ngModel)]="keepAttributes" name="keepAttributes">
              <span class="switchslider round"></span>
            </label>
            <div class="help-block">
              <p>Angabe, ob alle sonstigen Attribute des importierten Datensatzes mit gleichem Namen übernommen werden sollen. Falls nicht, so lassen sich einzelne Attribut-Importe definieren.</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-sm-6 col-xs-12" *ngIf="!keepAttributes">
          <div class="form-group">
            <label>Fehlende/NULL Werte beibehalten*</label>
            <br/>	
            <label class="switch">
              <input type="checkbox" [(ngModel)]="keepMissingValues" name="keepMissingValues">
              <span class="switchslider round"></span>
            </label>
            <div class="help-block">
              <p>Angabe, ob fehlende Attribute oder leere Attributwerte (<code>NULL</code>-Werte) übernommen werden. Bei deaktivierter Option wird bei einem solchen Fall ein Fehler geworfen.</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="!keepAttributes" class="row vertical-align">
        <div class="col-md-6 col-sm-6 col-xs-12">
          <div class="form-group">
            <label>Attributname im zu importierenden Datensatz*</label>
            <input 
              type="text" 
              class="form-control input-sm" 
              placeholder="Quell-Attributname" 
              [(ngModel)]="attributeMapping_sourceAttributeName"
              name="attributeMapping_sourceAttributeName"
            >
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label>Ziel-Attributname in Datenbank nach Import*</label>
            <input 
              type="text" 
              class="form-control input-sm" 
              placeholder="Ziel-Attributname" 
              [(ngModel)]="attributeMapping_destinationAttributeName"
              name="attributeMapping_destinationAttributeName"
            >
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <label>Datentyp*</label>
            <select 
              [(ngModel)]="attributeMapping_attributeType"
              name="attributeMapping_attributeType"
              class="form-control" 
              required
            >
              <option [ngValue]="null"> -- Datentyp wählen -- </option>
              <option *ngFor="let type of kommonitorImporterHelperService.attributeMapping_attributeTypes" [ngValue]="type">
                {{type.displayName}}
              </option>
            </select>
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <button 
              class="btn btn-success btn-sm" 
              [disabled]="!attributeMapping_sourceAttributeName || !attributeMapping_destinationAttributeName || !attributeMapping_attributeType" 
              (click)="onAddOrUpdateAttributeMapping()"
            >
              Hinzufügen/Editieren
            </button>
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-6 col-sm-6 col-xs-12">
          <label>Übersicht der definierten Attribut-Mappings</label>
          <table class="table table-condensed">
            <thead>
              <tr>
                <th>Editierfunktionen</th>
                <th>Quell-Attributname im Datensatz</th>
                <th>Ziel-Attributname nach Import</th>
                <th>Datentyp</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let attributeMappingEntry of attributeMappings_adminView">
                <td>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-warning btn-sm" type="button" (click)="onClickEditAttributeMapping(attributeMappingEntry)"
                      title="Referenz editieren">
                      <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" type="button" (click)="onClickDeleteAttributeMapping(attributeMappingEntry)"
                      title="Referenz löschen">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
                <td>{{attributeMappingEntry.sourceName}}</td>
                <td>{{attributeMappingEntry.destinationName}}</td>
                <td>{{attributeMappingEntry.dataType.displayName}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <input type="button" name="previous" class="previous previous_addSpatialUnit action-button-previous" value="Voriger Schritt" (click)="previousStep()"/>
    </fieldset>
  </form>
  <!-- /.MultiStep Form -->
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-default pull-left" (click)="cancel()">Schließen</button>
  <button type="button" class="btn btn-info pull-left" (click)="onImportSpatialUnitAddMetadata()" title="Importieren der Metadaten aus einer Datei">
    <i class="fas fa-file-import"></i>&nbsp;&nbsp;Metadaten-Import
  </button>
  <input style="display:none;" class="pull-left" type="file" #metadataImportFile (change)="onMetadataFileSelected($event)" accept=".json,">
  <button type="button" style="margin-left: 6px;" class="btn btn-info pull-left" (click)="onExportSpatialUnitAddMetadata()" title="Exportieren der Metadaten in eine Datei">
    <i class="fas fa-file-export"></i>&nbsp;&nbsp;Metadaten-Export
  </button>
  <button type="button" class="btn btn-success" type="submit" (click)="addSpatialUnit()" 
    [disabled]="!spatialUnitLevel || !metadata.description || !metadata.datasource || !metadata.contact || !metadata.updateInterval || !metadata.lastUpdate || !spatialUnitDataSourceIdProperty || !spatialUnitDataSourceNameProperty || !periodOfValidity.startDate || spatialUnitLevelInvalid || periodOfValidityInvalid || hierarchyInvalid || !converter || !datasourceType || !ownerOrganization">
    Raumeinheit registrieren
  </button>
  <button type="button" class="btn btn-danger" (click)="resetForm()">Zurücksetzen</button>
</div>

<!-- Success Alert -->
<div id="spatialUnitAddSucessAlert" style="position: absolute; bottom: 0px; width: 100%;" 
  *ngIf="successMessagePart" 
  class="alert alert-success alert-dismissable">
  <button type="button" class="close" (click)="hideSuccessAlert()" aria-hidden="true">&times;</button>
  <h4><i class="icon fa fa-check"></i>Raumebene registriert</h4>
  <p>Eine neue Raumebene mit Namen {{successMessagePart}} wurde in KomMonitor registriert und in die Übersichtstabelle eingetragen.</p>
  <div *ngIf="importedFeatures && importedFeatures.length > 0">
    {{importedFeatures.length}} Raumeinheiten wurden dabei importiert.
  </div>
</div>

<!-- Error Alert -->
<div id="spatialUnitAddErrorAlert" style="position: absolute; bottom: 0px; width: 100%;" 
  *ngIf="errorMessagePart" 
  class="alert alert-danger alert-dismissable">
  <button type="button" class="close" (click)="hideErrorAlert()" aria-hidden="true">&times;</button>
  <h4><i class="icon fa fa-ban"></i>Registrierung gescheitert</h4>
  Bei der Registrierung der Raumebene ist ein Fehler aufgetreten. Fehlermeldung:
  <br/>
  <pre style="overflow:auto; max-height:500px;" [innerHTML]="errorMessagePart"></pre>
  <br/>
  <br/>
  <div *ngIf="importerErrors">
    <p>Bei den {{importerErrors.length}} Raumeinheiten mit folgenden IDs scheitert der Import:</p>
    <pre style="overflow:auto; max-height:500px;">
      <ul>
        <li *ngFor="let error of importerErrors">{{error}}</li>
      </ul>
    </pre>	
    <p>Bitte beheben Sie die angezeigten Fehler im Datensatz und wiederholen den Prozess.</p>
  </div>
</div>

<!-- Metadata Import Error Alert -->
<div id="spatialUnitMetadataImportErrorAlert" style="position: absolute; bottom: 0px; width: 100%;" 
  *ngIf="spatialUnitMetadataImportError" 
  class="alert alert-danger alert-dismissable">
  <button type="button" class="close" (click)="hideMetadataErrorAlert()" aria-hidden="true">&times;</button>
  <h4><i class="icon fa fa-ban"></i>Metadata Import gescheitert</h4>
  Beim Import der Metadaten aus einer Datei ist ein Fehler aufgetreten. Fehlermeldung:
  <br/>
  <pre>{{spatialUnitMetadataImportError}}</pre>								
  <br/>								
  <br/>
  <p>Bitte stellen Sie sicher, dass folgendes JSON-Format eingehalten wird:</p>
  <pre id="spatialUnitsAddMetadataPre" style="overflow:auto; max-height:500px;"></pre>
</div>

<!-- Mapping Config Import Error Alert -->
<div id="spatialUnitMappingConfigImportErrorAlert" style="position: absolute; bottom: 0px; width: 100%;" 
  *ngIf="spatialUnitMappingConfigImportError" 
  class="alert alert-danger alert-dismissable">
  <button type="button" class="close" (click)="hideMappingConfigErrorAlert()" aria-hidden="true">&times;</button>
  <h4><i class="icon fa fa-ban"></i>Mapping-Konfiguration Import gescheitert</h4>
  Beim Import der Mapping-Konfiguration aus einer Datei ist ein Fehler aufgetreten. Fehlermeldung:
  <br/>
  <pre [innerHTML]="spatialUnitMappingConfigImportError"></pre>								
  <br/>								
  <br/>
  <p>Bitte stellen Sie sicher, dass folgendes JSON-Format eingehalten wird:</p>
  <pre id="spatialUnitsAddMappingConfigPre" style="overflow:auto; max-height:500px;"></pre>
</div> 